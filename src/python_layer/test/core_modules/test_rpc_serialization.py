import unittest

from decimal import Decimal

from core_modules.rpc_serialization import pack_and_sign, verify_and_unpack


class TestRPCSerialization(unittest.TestCase):
    def setUp(self):
        self.message = ["RPCNAME", "This is some test string", 0, 0.0, Decimal(1)/Decimal(3)]

        self.receiver_privkey = b'\xb6\x97\x9f\xec\xe7@>\xc7\'j\x17/\xba\x83\x0c\xaba\xa4\xab\x92\xb4s\xc9\x0b\xbd\xb8fa\x8f\xa4\xb1\xe5o\x0f\x1b\xc8\x838\xb0\xc3\xf2$>M\x82v3\xe5\xdc\xedm\xb4rf\xba\xa4_\xaeW\xdd/\x86h\xd9yM\xcf]q%\xed`\x8aq\xb2\x8by\x0f\xa8k\xb3\x8d\xf0\t\x05\xa1\x05)i\x95\xc21\xa7\xa4>\x87\xe1\x7f&Ce[;\xa3\x0bGp\x8e]EPT;\xe0\x86`\xb7\xb5\x94\xf5\xc9\tp\x16\x9cj4R\xe0\xb1_a!(\xb2\x80@\x9fj\x8a\xd3{\xefR F\xdc\xa55\xcf\x9d\x8f^G\xb0\xc8\x7fZ\x87)\xf3\x1f\xfb\x9551\xac7\xb6\x87yS\xcc(\x0c\x93r<\xb1\x16f\x8bldu\xc6\xa2\x0c\x95\'@\x99jb\xd3\xd12\xady\xad\xbeP\x8d\t\xefR\x18/\xa3\xdb\x16\x1f\xbe \x99\x89\xc3\xc2\xbaM\xb7\x9eV\xac\xed\xe9=w\x9a\x8et\xc9\xb58\x06\x94L\xb1\xab\xaaD\x92}\x95\x97\xfb{=O\xf3#\xc1\x05\xe3\xd4v$+5*\xc8\xe3\xf6-w\xc9\xed\xadg\xb5\xe5=2\x8d\xd8\xfc\xc1-61\x87\xcdg\xf2\xcc]\x98\x02\x9aO\xd1z\x12\x1c\x8a\xec\xf0\x14\xf5\xf76i\xe86\xc5\x03vP\x88\xe2Idf\xcb\x91xo\xe4\x9e\xed\xdel]"V\xd1yom\xaf\xf1?\xbb\x16\x14\x87vq\xa0L\xec\xd9Io\xb1\xb2\x16=bY\x10\xf1\xfeh\xd6N\'\t\x8a\xfe1\xbf\xe67\xac3G/\xc3\xadR)\xc8\xa1\x8c\x01\xa0\x90Q|\n\xee\x18}h2\r\xaf\xb2s\xf53.\xf0\xc8\xf7#7A]OIE\xf3\xdd\xde\x05\r\xedb\xd30s\xac-#a([\x06\xef\xae\xac\x80=C=5\x04U\x81\xa7\xd9\xec\x14\xac\xa5x?\x9c\xe6\xfd\xbe\xfc\xb4\nv\xd1\xb9\x1d\xe0\xcb8\xab\x1d\x96\xfd\x7f&\xf1\x89\x89$\xb2\x8b"\xa6\xfaV\x90\x88+MFa\x8c\xa9\x82\xd5i\xe3\t\xd2l\xd7\xac\xd9\xdeQ\xfc\x05\'\xe7?\xd5\xde\xbf\xe8\x9e\x8b{\xeb\xe8B\x1b\xdeY\xae\xa1\x05n\xd1\xe6\xc5\xcd\x05\xa1\xab#\x07\xe6\xa5\xef`\x04\x10\xfd0\xeb\x91\xc0zn\xdc\xd8t\x93\t\xcf\xda\x0c\xdb4\x1c\x90\xff\xe9\x08X\xe7\x08\x0e\x8e[--NQ`G\x9e1\xd7\xb9\xac\xb7\x13\xc7\xfa\xc4\xa0O\xd6\x1b\xb5q7K\x08\xe5/\xdfk\xd3\x16(\xb0\x18\x89\xe9\x10\x14\xd5\xce\x0f\x89\xdad\xb2\x1bl\xf6\xc9>I\x06\xc0\xd3k\xfd\xa8\xec\xd9\xbb/n\xb2\xae\xaa,\xc9\xed\xaa\x01{Z/\xa17\xdcY\xa9\x19\xc5d"\x81\x01\xe1\x8f\xa4\xcc\x90\xf0\xb8\xed\xe7`N\x8b\x8f\x8a gh\x1d\x11|\xa6x\x17Y\xbe\xff\xbfE|\x9b?\xa7\x84aTs\x8d\xfb\xfe\xc3[\xa3\x8d\x12\xbe\x94\x9b)U\xaf\xe6\t\xfb\xbf\xb26g{).\xf4\xb7\xb9tH\x95o\xde\xf3\xf8\xac\xca\xc7|\x1e\xfb\xb2O\x9e\xa0\xb6\xc82\xa4\x1b\xe5G \xc3N\xae\x90\x0e\xdd0TS\xc3"\xda\xf1|g6\xcd~g\xc3q\x07&\xf2\x7f\x96\xc8q\x18\x0bSV~x\x98\xd4FY\xf1\xb9jl\xdcc\xcb\x90Z\xdf\xe2\xf6.\xe59\xcb,\x18\xff\xc6\xca \xeejf\x93\xb6t\x13\x87\xe9K\x1b\x98\xc2*&\x14\x1bx\xf4\xd6\xfd\xdc\x13j\x08\xe7Z\xc7\xd7\x8f\x81\xbf\xe5.\xe0tN\xb1{\xf4A\xfd\xa9e("\x93\xd7\t\x915J\x1eG\x82z\xccL\x18>\xc6[\x84\x02\xd4\x89h9\x14\xba~h\xeb6\xd4Uo\xb7#\xcf\xce\x93\xb1q^\xb6\xf1xL0\xb7\x04\xc8<\xb0\xa4e?\xbe\x0e4[k\xcf\xb3d\xba\x01I;\xae\x9f\xc1X\xa2\xb04~\xfb\xacW\xbc\xc0\nFB\xfa94\x85\xef\x120\xc0\xba\xe5(\xeb7\xa9\xe7L\xd8\x1e\xc2=\xde*O|\x00\xf6\xe1\xe7r\x9c9-s\xfc\xa5\x1f\x89\x17\x8bA\xc0\xf6i"\xd4\xb3\x86\x161b\xad\'\x92H\xefT\xc4\xfe\xee\xb2\xea\xbd\xb9\xad\xb6_\xb4\xc0\x92\x92\xcb%\xf6\xb7\xf8\xca\x1a\xbdL\xa5B\xcb\xcb7\x96#K\x8d:\xf6\x1c\xa7LR\xa0\x94\xb5\ri\x19\xdf\r`x;h\x1a\xb4\x81\xa8\xa4_\xe7\x83p&\xd7\t\x19\x98\xd4\x11\xb0\x82G3h\xf1\x03\x04'
        self.receiver_pubkey = b"q\xa4wF]\xda2S?\x04\xbd\x1e\xad\x93\x97\xa1I\x0b=\xbe\xe8\x82\xe1\xf5\xdb\x11\x03\xc7\x0e\x08\x01'\xe49\xe1+\xd3$\x05\xa10Hj\xa7F\xb5\xb0\xcc\xdd&\x95\xe0\x89\xb1}3\xcb\xc8ce\x83\x1c,%\xb9\x00"

        self.sender_privkey = b'q\xda\xdd\xbf.\xfb\xbe\x01\xb2\xd3\x9ed\xe2\x8dTa\xd0"\xe0\xc5\x07r^\x80a\xbc{#\xaa\xef\x08G\x91\x9d\xed[^e\x87\x0e} \xcbW\xf9\xf5x\x81-\xaf;\x97\xa4(\xd3n\xacjr\xdf\xc1\x8aS*\xda\x86Q\xd1\xedI\xad\xd94\xa7\xa7<\xcb\n\xa6\x01\x11h\x84\xc8\xfewhu\x14d\x99\xad\x91S\x99\x16\xccy\xfc\x07\x8a\x05\x82\x87N\x1e"L\x14\x08]^7\x05\xc2\x9c\xc2K\x80\xde#l\x9c\x99R\x90g\x05\xe3\xf8\x7f/\xc3c\xa8\x95\xe1%\x18K\xa4\xcca\xa9\x0e\xc9i\xe4iL\x97@\xdb>5\xbd\xdc`\x1f\xce\xd8\xf8\xdb\x93\x0c\x9a\xc6\x97V\xc2\xc7=\xd8\xe6@\x0f\xc9\xb4wZ\xed\x01\x83\xba\x0f\x86\xf1\x88\xcf\xca\xebg< ,\'N\x18\x04\x1e\xdbZ\xdf\x03\xfaq\x91Y\xfe6\x1b\xadE\x1f\xf8\xae\xb6W3\xb5\xc1\xfe\xb8<\xc6\\\xf1\x03\xc0G\x98\xcfO\xab\xc2D\x8b\xb3\xf5\x06\x83\xb0H\xf1\xab\xef\xc5\x9e\x10\xf0\xf4\x19\xc5x\x05\x18B\x8b\xe7\xf5J4\xe5\xc5\x1a\x02\x80\xaf\xe8\x978\x06\xe4=\xb0\xea\xe1@\x80\xed\xfc\x1b\xc9\xc3T\x88\'%d\xd4\x04\x9c\x80\xec\xbc,\xd1\x9dkp\xf7\x87\x12i\xfc~\xf8\x82\xe3\xab5\xef\xd9\x86\x8e9}j\xd2\'j\xb9\xa4\xb4d\x0eL\t\xb0G\x16g0\xdfX0\t>\x87\xe5L\x82Z\xba5*6\x9b\x99z\x8b\xa9\xcb\xeemP\x13\x93\xce\x02\xe6\x8c\xc6B\xdc5\x80P\x88\xaf2\x9baQ\x90\x8a\x9b\xf4\x89\x94$y\x07\x93\x95\xab\xdc\xfc\xdc,p\xa0\xf6\xcd\x05\xfc*\x16\x84\x13\xa4\xef\xc99\x13\xa3S\x99Xgm\x16K\x9c\x0c\xa4\xf6\x04Lw\x8cJ\xf01N\x8a\x8dv\x18\xa3S\xe8qo\xaf\xc8=eh\x9c\xe0\x16l\xb7\xe7!\x18\xf5%t\xf6\xd4F>\x16EP\x87\xbf\x0f\x90\xef3\xff\xc8\xe3\x97r\x01q\xc3\xc0#\xd4(\xd4I\x9aS\x83i\x08]~b\xd6\x0f\xb9\x084\x10z\x0b\x06\x94m\x8a&g\x7fO\xf2\x0b4\x85\xefF\xda{\xbe#F\xf5\x91Z\xb8\x9a\xac\x97\x07dX\xf4\xdd^\x1d\x99^\xdc?CF%~\x86w\xa4K\xff\xc8\x9f\x92\xda\xab\xf1\xafMM#\x8b\x9c\xe9\xcb^\xf8\x0bP\xbc\x90\x99MN\xb7Bu\x1a\xdb\x9e"\xdf$\x150*{\x14\x95\xdb\x1ca\xc4\xfc\x02)\xfa\x17\xad\x1c\xe2D\xce\xdao\xcd\x14\xd4\xd4\xbd\xe6\xc3\xfct#\xbaw\x80\x93\x9fG\x8b%a\xbal\xa0\x99Q\xa56\xb2\xe7\r\xfa\x9fU\xce\x18Q\xf6\x8d\xa3:\xfa.\xb0\xd4\xee\xa4qB|\xbf\xef\xe8\xaa!\xb8\x92m\xc6\x07\x87Nd\x0b/\x18\x8a\xd5\xe3\xf0CeI\xff\xed\xc0u\xfd~O\xf5\x93\xdf\x87i\xd7\x86\x82+\x06\xf9P\x9cY\xa6~\x9e\xbe\x17\xefD\x98F\xd9\xbc.\xc6\xb0\xfa\xac3\\\x88;B!T\xf1\xa7\xd5\xfa\xd5\xa4O\xc9\xf6Ia\x93\xb4\xe4C\xaa\xedP\xac\\\xea#;`C@\xae\xb5\x1e${\xd5\xea#f\xaat~\x91nQW\xd7\x82\xf0\x91\x98\x83B\xc8\x05\xfc\x82\xa7\x9c6\'\x80\xe0\xc0\xbaE\xd6\xe6\x8d\x86\xbbp\xed\x00\xb4\xed\xab\x08\x0f\x9aJ\xcc[\xcf#\xc69\x14\xe6\x12\x8fL\xf937\xa8\x1a\x9ck\xbd\xffe\x8c(\xee\xae;q@|\xaa"\xe5 \xd2G\x9fYR@\xe9\x1a\xc8\xbe\x8f\xbe\xc1\xc0(2\xa0\x9f\xf2]O\xa3\x90\x87\xff\xee\xf1;\xd2J\xb6s\x86\xbb*\xd6x\x96y\xd5\x9avN\xdb\xd2f\x98\xae\xebT\xdd\xd83/\xcb\t\r\x00\xe4|\x93\x05_\xd6\xab\x08\xcb\xcd3\xfan#jC`Wc\xee\xe0\xda\xd1\x02z\x9f\xedo\xd3\xa8\xf1m\xb9\x927.(\xf4\x85J\xbd\xda\xc6\xa2\xde\xff\x1f\x86\xdbp_\xfei7\xe8B\xe3\x85*\x96\xbf{\xfc\x99\xa4\xb7wj2G~\xa1\xb6\xdb\\V\xb8C\x90\xf8\x1a\xe8\xb3\x8b\x07~~\xfb\x1cL\n\xb8P\x16\x9f\xc1%\xc0\'x\x8a]r\x12\xbc\x13,\x9a)\xa6K\xa5$\xb1\xc0\xf0\x18V\xe5b\xdd\xd6P\x1bj\xb1\xe3\x86\xfb\x97\x80\x9c\x0c\x8c\xc0I\x86\x96\xc56\x02<\xc7-\xa2lo\xe4\\*\xe9\xa3\xac\xfd\x08\xedC\xe7\xf7k\xfb\xc0?\xce\xe1\xa6'
        self.sender_pubkey = b'p\x95n\x00\x19\xeb\xf4Qs\xbe6\x1f\xad\xf3\xc5\x8ayLd\x90r\x18_R\xd1+\x9a\xc1~\x0e\x1fB3\xcd\xd0\xc7\xd8l\xec\x1c\x0c\xdd3\xded[\x0c\x80\xc6Q\xaf\xf4\xce\xe6\xd6@\nb\xfe.\xffC\xc4dk\x81'

    def test_serialization_and_deserialization(self):
        raw_msg = pack_and_sign(self.sender_privkey, self.sender_pubkey, self.receiver_pubkey, self.message)
        sender_id, data = verify_and_unpack(raw_msg, self.receiver_pubkey)
        self.assertEqual(sender_id, self.sender_pubkey)
        self.assertEqual(data, self.message)
