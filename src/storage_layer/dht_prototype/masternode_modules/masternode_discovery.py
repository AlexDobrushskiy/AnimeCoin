import os


def discover_nodes(daemon_binary, regtestdir):
    settings_list = []
    for dir in sorted(os.listdir(regtestdir)):
        settingsfile = os.path.join(regtestdir, dir, "animecoin.conf")

        settings = {}
        for line in open(settingsfile):
            line = line.strip().split("=")
            settings[line[0]] = line[1]

        # set our settings
        # TODO: cofidy these settings in a concrete model and validate that everything we need is set
        settings["nodename"] = dir
        settings["nodeid"] = int(dir.lstrip("node"))
        settings["daemon_binary"] = daemon_binary
        settings["datadir"] = os.path.join(regtestdir, dir)
        settings["basedir"] = os.path.join(regtestdir, dir, "pymn")
        settings["ip"] = "127.0.0.1"
        settings["pyrpcport"] = int(settings["rpcport"]) + 1000

        # TODO: remove this:
        settings["pubkey"] = open(os.path.join(settings["basedir"], "config", "public.key")).read()

        settings_list.append(settings)
    return settings_list
